<!DOCTYPE html>
<meta charset="utf-8">
    <style>
        body {
          font-family: 'Open Sans', sans-serif;
        }
        .node rect {
          stroke: black;
          stroke-width: 1.5px;
        }

        .node {
          font: 17px;
        }

        .link {
          fill: none;
          stroke: #ccc;
          stroke-width: 2px;
        }

        .tick text {
          font: 20px;
        }

        .axis line, .axis path {
          fill: none;
          stroke: #000;
        }

        .select2-container {
          width: 400px;
          font: 18px;
        }
        
        .container {
          width: 600px;
          margin-left: auto;
          margin-right: auto;
          padding-top: 100px;
        }

        .chart h1 {
          margin-bottom: 0px;
          margin-left: 10px;
        }
    </style>
    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<body>
    <div class="container">
      <select class="gene-select" style="width:200px"></select>
      <div class="chart">
        <h1 class="title"></h1>
      </div>
    </div>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
<script>

var width = 800,
    height = 700,
    ymax = 1;

var treeLayout = d3.layout.tree()
    .size([width - 160, height - 100]);

var svg = d3.select(".chart").append("svg")
    .attr("width", width)
    .attr("height", height);

var legendAxis;

var tree = 
{'cellType': 'H7 hESC',
 'label': 'hESC',
'children': [

    {'cellType': 'APS',
     'label': 'Ant. PS',
     'children': [

        {'cellType': 'DLL1Pos PXM',
         'label': 'PXM',
         'children': [

            {'cellType': 'Somite',
             'label': 'Somite',
             'children': [

                {'cellType': 'Dermomyotome',
                 'label': 'Dermomyo',
                 'children': []},

                {'cellType': 'Sclerotome',
                 'label': 'Sclero',
                 'children': []}
            ]}
        ]}
    ]},

    {'cellType': 'MPS',
     'label': 'Mid PS',
     'children': [

        {'cellType': 'LatM',
         'label': 'Lat. Meso',
         'children': [

            {'cellType': 'H7 Cardiac',
             'label': 'Cardiac',
             'children': []}
        ]}
    ]}
]};

var colorScale = d3.scale.linear()
    .domain([0, 0.5 * ymax, ymax])
    .range(["white", "#FFB03B", "#B12800"]);

var buildLegend = function(colorScale, parentElem, width, height) {
    var ymax = Math.max(...colorScale.domain());
    var ymin = Math.min(...colorScale.domain());

    var legend_data = [];
    for (var i = 0; i < height; i++) {
      legend_data.push( (i / height * (ymax - ymin)) + ymin); 
      console.log(legend_data);
    }

    var legend_scale = d3.scale.linear()
      .domain([ymax, ymin])
      .range([0, height]);

    var legend_axis = d3.svg.axis()
      .scale(legend_scale)
      .orient("right")
      .tickValues(colorScale.domain());

    var key = parentElem.attr("width", width * 2).attr("height", height * 2);

    key.append("g")
      .attr("class", "legend axis")
      .attr("transform", "translate(" + (5 + width / 2) + ", 30)")
      .call(legend_axis)
    .selectAll(".legend_cell")
      .data(legend_data)
      .enter().append("rect")
      .attr("y", function(d, i) { return i;})
      .attr("x", -width / 2)
      .attr("width", width / 2)
      .attr("height", 1)
      .attr("fill", function(d) { return colorScale(ymax - d + ymin); });
};

var elbow = function(d, i) {
  var alpha = 0.5;
  return "M" + d.source.x + "," + d.source.y
      + "V" + (d.source.y * (1 - alpha) + d.target.y * alpha)
      + "H" + d.target.x
      + "V" + d.target.y;
}

var renderTree = function(tree) {
  var nodes = treeLayout.nodes(tree);
  var tree = svg.append("g")
    .attr("transform", "translate(-50, 50)");

  var link = tree.selectAll("path.link")
      .data(treeLayout.links(nodes))
    .enter().append("path")
      .attr("class", "link")
      .attr("d", elbow);

  var node = tree.selectAll("g.node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })

  node.append("rect")
      .attr("width", "90")
      .attr("height", "90")
      .attr("fill", "white")
      .attr("transform", "translate(-45, -45)")

  node.append("text")
      .attr("dx", 0)
      .attr("dy", 3)
      .attr("text-anchor", "middle")
      .text(function(d) { return d.label; })
      .attr("fill", "black");
}

d3.csv("assets/allGenesT.csv", function (x) {
  var augmentTree = function(node) {
    node.geneValues = _.findWhere(x, {'cellType': node.cellType});
    for (var i = 0, len = node.children.length; i < len; i++) {
      augmentTree(node.children[i]);
    }
  };
  augmentTree(tree);
  renderTree(tree);
  
  var genes = [];
  _.each(_.keys(x[0]), function (gene) {
    if (gene != "cellType")
      genes.push({"id": gene, "text": gene});
  });
    
  $(".gene-select").select2({data: genes})
    .on("select2:select", function (e) {
      var gene = this.value;
      var ymax = _.reduce(x, function(ymax, cell) {return Math.max(ymax, cell[gene])}, -Infinity);
      var ymin = _.reduce(x, function(ymin, cell) {return Math.min(ymin, cell[gene])}, Infinity);

      var colorScale = d3.scale.linear()
        .domain([ymin, 0.5 * (ymin + ymax), ymax])
        .range(["white", "#FFB03B", "#B12800"]);

      svg.selectAll(".node rect")
        .attr("fill", function(d) {return colorScale(d.geneValues[gene])})
      svg.selectAll(".node text")
        .attr("fill", function(d) {return ((d.geneValues[gene] - ymin) / (ymax - ymin) > 0.8) ? "white" : "black"})
        
      d3.select(".title")
        .text(gene);

      d3.select(".legendContainer").remove();
      var legend = svg.append("g").attr("width", 160).attr("height", 400)
        .attr("transform", "translate(" + (width - 160) + ", 50)")
        .attr("class", "legendContainer");
      buildLegend(colorScale, svg.select(".legendContainer"), 80, 200);
    });
});

</script>
</body>
</html>
